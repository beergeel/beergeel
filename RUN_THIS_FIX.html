<!DOCTYPE html>
<html>
<head>
    <title>Pharmacy Stock Database Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #3498db;
            text-align: center;
        }
        .step {
            background: #e8f4f8;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
            border-radius: 5px;
        }
        .step h2 {
            margin-top: 0;
            color: #2c3e50;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
        }
        button:hover {
            background: #2980b9;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #c3e6cb;
            text-align: center;
            margin: 20px 0;
        }
        .code {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ffeeba;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Pharmacy Stock Database Fix</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è Important:</strong> This will reset your pharmacy_stock table. Any existing items will be deleted. The test item can be deleted from the app after.
        </div>

        <div class="step">
            <h2>Step 1: Copy the SQL Fix</h2>
            <p>Click the button below to copy the complete fix to your clipboard:</p>
            <button onclick="copySQLFix()">üìã Copy SQL Fix to Clipboard</button>
            <div id="copyStatus"></div>
        </div>

        <div class="step">
            <h2>Step 2: Go to Supabase</h2>
            <ol>
                <li>Open <a href="https://supabase.com/dashboard/project/wbcnyzzvynqgoaexehor/sql/new" target="_blank">Supabase SQL Editor</a></li>
                <li>Click "New Query"</li>
                <li>Paste the SQL (Ctrl+V or Cmd+V)</li>
                <li>Click "Run" or press Ctrl+Enter</li>
            </ol>
        </div>

        <div class="step">
            <h2>Step 3: Verify Success</h2>
            <p>After running the SQL, you should see:</p>
            <div class="code">
                status: "Table created successfully!"<br>
                item_count: 1
            </div>
            <p>Plus a list of all the table columns.</p>
        </div>

        <div class="step">
            <h2>Step 4: Test in Your App</h2>
            <ol>
                <li>Go back to your application</li>
                <li>Go to Pharmacy Stock</li>
                <li>Try adding a new medication</li>
                <li>It should work immediately! ‚úÖ</li>
                <li>Delete the test item if you want</li>
            </ol>
        </div>

        <div class="success" id="successMessage" style="display: none;">
            ‚úÖ SQL copied to clipboard! Now paste it in Supabase SQL Editor.
        </div>
    </div>

    <script>
        async function copySQLFix() {
            const sql = `-- ULTIMATE PHARMACY STOCK FIX
DROP TABLE IF EXISTS pharmacy_stock CASCADE;

CREATE TABLE pharmacy_stock (
    id BIGSERIAL PRIMARY KEY,
    medication_name TEXT NOT NULL,
    generic_name TEXT,
    category TEXT,
    quantity INTEGER NOT NULL DEFAULT 0,
    unit TEXT DEFAULT 'units',
    unit_price NUMERIC(10, 2) DEFAULT 0.00,
    expiry_date DATE,
    batch_number TEXT,
    supplier TEXT,
    reorder_level INTEGER DEFAULT 10,
    status TEXT DEFAULT 'active',
    notes TEXT,
    image_url TEXT,
    created_by INTEGER,
    created_date TIMESTAMPTZ DEFAULT NOW(),
    updated_date TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE pharmacy_stock DISABLE ROW LEVEL SECURITY;

GRANT ALL ON pharmacy_stock TO anon;
GRANT ALL ON pharmacy_stock TO authenticated;
GRANT ALL ON pharmacy_stock TO service_role;
GRANT ALL ON pharmacy_stock TO public;
GRANT USAGE, SELECT ON SEQUENCE pharmacy_stock_id_seq TO anon;
GRANT USAGE, SELECT ON SEQUENCE pharmacy_stock_id_seq TO authenticated;
GRANT USAGE, SELECT ON SEQUENCE pharmacy_stock_id_seq TO public;

CREATE INDEX idx_pharmacy_stock_medication ON pharmacy_stock(medication_name);
CREATE INDEX idx_pharmacy_stock_category ON pharmacy_stock(category);
CREATE INDEX idx_pharmacy_stock_status ON pharmacy_stock(status);

CREATE OR REPLACE FUNCTION update_pharmacy_stock_status()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.expiry_date IS NOT NULL AND NEW.expiry_date < CURRENT_DATE THEN
        NEW.status := 'expired';
    ELSIF NEW.quantity <= 0 THEN
        NEW.status := 'out_of_stock';
    ELSE
        NEW.status := 'active';
    END IF;
    NEW.updated_date := NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_pharmacy_stock_status ON pharmacy_stock;
CREATE TRIGGER trigger_pharmacy_stock_status
    BEFORE INSERT OR UPDATE ON pharmacy_stock
    FOR EACH ROW
    EXECUTE FUNCTION update_pharmacy_stock_status();

INSERT INTO pharmacy_stock (
    medication_name, generic_name, category, quantity, unit, unit_price, notes, created_by
) VALUES (
    'Test Medication', 'Test Generic Name', 'Antibiotic', 100, 'tablets', 5.00, 
    'This is a test item - you can delete it from the app', 1
);

SELECT 'Table created successfully!' as status, COUNT(*) as item_count FROM pharmacy_stock;
SELECT column_name, data_type, is_nullable FROM information_schema.columns WHERE table_name = 'pharmacy_stock' ORDER BY ordinal_position;`;

            try {
                await navigator.clipboard.writeText(sql);
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('copyStatus').innerHTML = '<p style="color: green; margin-top: 10px;">‚úÖ Copied! Now paste in Supabase SQL Editor.</p>';
            } catch (err) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = sql;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('copyStatus').innerHTML = '<p style="color: green; margin-top: 10px;">‚úÖ Copied! Now paste in Supabase SQL Editor.</p>';
            }
        }
    </script>
</body>
</html>

