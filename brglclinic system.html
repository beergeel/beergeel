<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beergeel Obstetrics and Gynecology Clinic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--dark-text);
        }
        
        /* Home Page Styles */
        .home-page {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .home-container {
            max-width: 1200px;
            width: 100%;
        }
        
        .clinic-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .home-logo {
            width: 120px;
            height: 120px;
            object-fit: contain;
            border-radius: 50%;
            border: 5px solid white;
            padding: 5px;
            margin-bottom: 20px;
            background: white;
        }
        
        .clinic-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .clinic-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .clinic-location {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .home-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 768px) {
            .home-content {
                grid-template-columns: 1fr;
            }
        }
        
        .notice-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }
        
        .notice-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: white;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }
        
        .notice-content {
            font-size: 1rem;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .login-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            color: var(--dark-text);
        }
        
        .login-title {
            color: var(--primary-color);
            font-size: 1.8rem;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .footer-info {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, #34495e 100%);
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 50%;
            border: 3px solid white;
            padding: 2px;
        }
        
        .clinic-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        
        .sidebar {
            background-color: white;
            min-height: calc(100vh - 80px);
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            position: fixed;
            width: 250px;
            padding-top: 20px;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            min-height: calc(100vh - 80px);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #2980b9 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #2980b9 100%);
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 600;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--accent-color) 0%, #c0392b 100%);
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 600;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #27ae60 100%);
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 600;
        }
        
        .nav-link {
            color: var(--dark-text);
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover, .nav-link.active {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #2980b9 100%);
            color: white;
        }
        
        .nav-link i {
            width: 25px;
            text-align: center;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--secondary-color);
            margin: 10px 0;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .patient-queue {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 5px solid var(--secondary-color);
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .queue-badge {
            background: var(--accent-color);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .currency-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 5px;
        }
        
        .notice-board {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffd43b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .notice-header {
            color: #e74c3c;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tab-content {
            padding: 20px 0;
        }
        
        .tab-pane {
            animation: fadeIn 0.5s ease;
        }
        
        .queue-status {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-waiting { background: #f39c12; color: white; }
        .status-inprogress { background: #3498db; color: white; }
        .status-results { background: #9b59b6; color: white; }
        .status-completed { background: #2ecc71; color: white; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                min-height: auto;
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Home Page -->
    <div id="homePage" class="home-page">
        <div class="home-container">
            <div class="clinic-header">
                <img src="https://via.placeholder.com/120x120/1e3c72/ffffff?text=OBGYN" alt="Beergeel Clinic Logo" class="home-logo" id="homeLogo">
                <h1 class="clinic-title">Beergeel Obstetrics and Gynecology Clinic</h1>
                <p class="clinic-subtitle">Takhasusuka sare ee xanuunada dumarka</p>
                <div class="clinic-location">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Xero awr kasoo horjeedka Ayuub Restaurant inyar ka xiga dhanka Masjid Nuur</span>
                </div>
                <p><i class="fas fa-phone"></i> Contact: 0634026635 (Mobile/WhatsApp)</p>
            </div>
            
            <div class="home-content">
                <div class="notice-section">
                    <h3 class="notice-title"><i class="fas fa-bell"></i> Clinic Notices</h3>
                    <div class="notice-content" id="homeNotice">
                        Welcome to Beergeel Obstetrics and Gynecology Clinic. Please update this notice with important information.
                    </div>
                </div>
                
                <div class="login-section">
                    <h3 class="login-title">System Login</h3>
                    
                    <div class="mb-3">
                        <label class="form-label">Login ID (Phone Number)</label>
                        <input type="text" class="form-control" id="loginId" placeholder="e.g., 4026635">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" value="1234">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Login As</label>
                        <select class="form-select" id="loginRole">
                            <option value="patient">Patient</option>
                            <option value="reception">Reception</option>
                            <option value="doctor">Doctor</option>
                            <option value="pharmacy">Pharmacy</option>
                            <option value="lab">Laboratory</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary w-100" onclick="login()">
                        <i class="fas fa-sign-in-alt"></i> Login to System
                    </button>
                    
                    <div class="text-center mt-3">
                        <small class="text-muted">Default password: 1234</small>
                    </div>
                </div>
            </div>
            
            <div class="footer-info">
                <p>© 2024 Beergeel Obstetrics and Gynecology Clinic. All rights reserved. | Your Health is Our Priority</p>
            </div>
        </div>
    </div>

    <!-- Main Application (Initially Hidden) -->
    <div id="mainApp" style="display: none;">
        <!-- Navigation Bar -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container-fluid">
                <div class="logo-container">
                    <img src="https://via.placeholder.com/60x60/2c3e50/ffffff?text=OBGYN" alt="Clinic Logo" class="logo-img" id="navbarLogo">
                    <span class="clinic-name">Beergeel Obstetrics & Gynecology Clinic</span>
                </div>
                
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> ${currentUser?.name || currentUser?.username}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="changePassword()"><i class="fas fa-key"></i> Change Password</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar"></div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Content will be dynamically loaded here -->
        </div>
    </div>

    <script>
        // Database simulation using localStorage
        class ClinicDB {
            constructor() {
                this.initDatabase();
            }

            initDatabase() {
                const tables = [
                    'patients', 'visits', 'users', 'consultations', 
                    'lab_requests', 'prescriptions', 'payments', 
                    'expenses', 'notices', 'appointments', 'messages', 'queue'
                ];

                tables.forEach(table => {
                    if (!localStorage.getItem(table)) {
                        localStorage.setItem(table, JSON.stringify([]));
                    }
                });

                if (JSON.parse(localStorage.getItem('users')).length === 0) {
                    this.setupDefaultUsers();
                }
                
                if (JSON.parse(localStorage.getItem('notices')).length === 0) {
                    this.setupDefaultNotice();
                }
            }

            setupDefaultUsers() {
                const users = [
                    { 
                        id: 1, 
                        username: '4026635', 
                        password: '1234', 
                        role: 'reception',
                        name: 'Reception Staff',
                        mobile: '4026635'
                    },
                    { 
                        id: 2, 
                        username: '4696972', 
                        password: '1234', 
                        role: 'doctor',
                        name: 'Dr. Ahmed',
                        mobile: '4696972'
                    },
                    { 
                        id: 3, 
                        username: '4730530', 
                        password: '1234', 
                        role: 'pharmacy',
                        name: 'Pharmacy Staff',
                        mobile: '4730530'
                    },
                    { 
                        id: 4, 
                        username: '8144099', 
                        password: '1234', 
                        role: 'lab',
                        name: 'Lab Technician',
                        mobile: '8144099'
                    }
                ];
                localStorage.setItem('users', JSON.stringify(users));
                
                // Add some sample patients
                if (JSON.parse(localStorage.getItem('patients')).length === 0) {
                    const patients = [
                        {
                            id: 1,
                            name: "Ali Hassan",
                            age: 35,
                            sex: "Male",
                            mobile: "1234567",
                            password: "1234",
                            registered_by: 1,
                            created_date: new Date().toISOString()
                        },
                        {
                            id: 2,
                            name: "Fatima Ahmed",
                            age: 28,
                            sex: "Female",
                            mobile: "2345678",
                            password: "1234",
                            registered_by: 1,
                            created_date: new Date().toISOString()
                        }
                    ];
                    localStorage.setItem('patients', JSON.stringify(patients));
                }
                
                // Add some sample notice
                if (JSON.parse(localStorage.getItem('notices')).length === 0) {
                    const notice = {
                        id: 1,
                        content: 'Welcome to Beergeel Obstetrics and Gynecology Clinic. Clinic hours: 8:00 AM - 10:00 PM. Emergency services available 24/7.',
                        updated_by: 'System',
                        updated_date: new Date().toISOString()
                    };
                    localStorage.setItem('notices', JSON.stringify([notice]));
                }
            }

            setupDefaultNotice() {
                const notice = {
                    id: 1,
                    content: 'Welcome to Beergeel Obstetrics and Gynecology Clinic. Please update this notice with important information.',
                    updated_by: 'System',
                    updated_date: new Date().toISOString()
                };
                localStorage.setItem('notices', JSON.stringify([notice]));
            }

            getAll(table) {
                return JSON.parse(localStorage.getItem(table) || '[]');
            }

            getById(table, id) {
                const items = this.getAll(table);
                return items.find(item => item.id == id);
            }

            add(table, data) {
                const items = this.getAll(table);
                const newId = items.length > 0 ? Math.max(...items.map(i => i.id)) + 1 : 1;
                const newItem = { id: newId, ...data, created_date: new Date().toISOString() };
                items.push(newItem);
                localStorage.setItem(table, JSON.stringify(items));
                return newItem;
            }

            update(table, id, data) {
                const items = this.getAll(table);
                const index = items.findIndex(item => item.id == id);
                if (index !== -1) {
                    items[index] = { ...items[index], ...data, updated_date: new Date().toISOString() };
                    localStorage.setItem(table, JSON.stringify(items));
                    return true;
                }
                return false;
            }

            delete(table, id) {
                const items = this.getAll(table);
                const filtered = items.filter(item => item.id != id);
                localStorage.setItem(table, JSON.stringify(filtered));
                return items.length !== filtered.length;
            }

            findPatientByMobile(mobile) {
                const patients = this.getAll('patients');
                return patients.find(p => p.mobile === mobile);
            }

            getTodayVisits() {
                const visits = this.getAll('visits');
                const today = new Date().toDateString();
                return visits.filter(v => new Date(v.created_date).toDateString() === today);
            }

            getPatientVisits(patientId) {
                const visits = this.getAll('visits');
                return visits.filter(v => v.patient_id == patientId);
            }

            getQueueForDepartment(dept) {
                const queue = this.getAll('queue');
                const visits = this.getAll('visits');
                const patients = this.getAll('patients');
                
                return queue.filter(q => q.department === dept && q.status !== 'completed').map(q => {
                    const visit = visits.find(v => v.id == q.visit_id);
                    const patient = patients.find(p => p.id == visit?.patient_id);
                    const consultation = this.getAll('consultations').find(c => c.visit_id == visit?.id);
                    return {
                        ...q,
                        visit: visit,
                        patient: patient,
                        consultation: consultation
                    };
                });
            }

            searchPatients(searchTerm) {
                const patients = this.getAll('patients');
                if (!searchTerm) return patients.slice(0, 50);
                
                return patients.filter(p => 
                    p.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    p.mobile.includes(searchTerm)
                );
            }

            getUserByUsername(username) {
                const users = this.getAll('users');
                return users.find(u => u.username === username);
            }

            getConsultationForVisit(visitId) {
                const consultations = this.getAll('consultations');
                return consultations.find(c => c.visit_id == visitId);
            }
        }

        const db = new ClinicDB();
        let currentUser = null;
        let currentRole = null;

        // Function to update home page notice
        function updateHomePageNotice() {
            const notices = db.getAll('notices');
            const homeNoticeElement = document.getElementById('homeNotice');
            if (homeNoticeElement && notices.length > 0) {
                homeNoticeElement.textContent = notices[0].content;
            } else if (homeNoticeElement) {
                homeNoticeElement.textContent = 'No notice available. Please add a new notice.';
            }
        }

        // Load notice on home page
        document.addEventListener('DOMContentLoaded', function() {
            updateHomePageNotice();
            
            // Initialize Bootstrap tooltips if any
            if (typeof bootstrap !== 'undefined') {
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
        });

        function login() {
            const loginId = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;
            const role = document.getElementById('loginRole').value;

            if (!loginId || !password) {
                alert('Please enter login ID and password');
                return;
            }

            if (role === 'patient') {
                const patient = db.findPatientByMobile(loginId);
                if (patient && patient.password === password) {
                    currentUser = patient;
                    currentRole = 'patient';
                    showMainApp();
                } else {
                    alert('Invalid patient credentials. Please check mobile number and password.');
                }
            } else {
                const users = db.getAll('users');
                const user = users.find(u => 
                    u.username === loginId && 
                    u.password === password && 
                    u.role === role
                );
                
                if (user) {
                    currentUser = user;
                    currentRole = role;
                    showMainApp();
                } else {
                    alert('Invalid credentials. Please check login details.');
                }
            }
        }

        function logout() {
            currentUser = null;
            currentRole = null;
            
            // Refresh home page notice when logging out
            updateHomePageNotice();
            
            document.getElementById('homePage').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginId').value = '';
            document.getElementById('loginPassword').value = '1234';
        }

        function showMainApp() {
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            loadSidebar();
            loadDashboard();
        }

        function loadSidebar() {
            const sidebar = document.getElementById('sidebar');
            let menuItems = [];

            switch(currentRole) {
                case 'reception':
                    menuItems = [
                        { icon: 'fa-home', text: 'Dashboard', action: 'loadDashboard' },
                        { icon: 'fa-user-plus', text: 'Register Patient', action: 'loadRegisterPatient' },
                        { icon: 'fa-stethoscope', text: 'Create Visit', action: 'loadCreateVisit' },
                        { icon: 'fa-list', text: 'Patient List', action: 'loadPatientList' },
                        { icon: 'fa-money-bill', text: 'Financial', action: 'loadFinancial' },
                        { icon: 'fa-users-cog', text: 'Account Management', action: 'loadAccountManagement' },
                        { icon: 'fa-bell', text: 'Notice Board', action: 'loadNoticeBoard' },
                        { icon: 'fa-chart-bar', text: 'Reports', action: 'loadReports' }
                    ];
                    break;
                case 'doctor':
                    menuItems = [
                        { icon: 'fa-home', text: 'Dashboard', action: 'loadDashboard' },
                        { icon: 'fa-users', text: 'Patient Queue', action: 'loadDoctorQueue' },
                        { icon: 'fa-list', text: 'Patient List', action: 'loadPatientList' },
                        { icon: 'fa-clipboard', text: 'Consultations', action: 'loadConsultations' },
                        { icon: 'fa-money-bill', text: 'Financial View', action: 'loadFinancialView' }
                    ];
                    break;
                case 'pharmacy':
                    menuItems = [
                        { icon: 'fa-home', text: 'Dashboard', action: 'loadDashboard' },
                        { icon: 'fa-users', text: 'Pharmacy Queue', action: 'loadPharmacyQueue' },
                        { icon: 'fa-prescription', text: 'Prescriptions', action: 'loadPrescriptions' }
                    ];
                    break;
                case 'lab':
                    menuItems = [
                        { icon: 'fa-home', text: 'Dashboard', action: 'loadDashboard' },
                        { icon: 'fa-users', text: 'Lab Queue', action: 'loadLabQueue' },
                        { icon: 'fa-flask', text: 'Lab Tests', action: 'loadLabTests' }
                    ];
                    break;
                case 'patient':
                    menuItems = [
                        { icon: 'fa-home', text: 'Dashboard', action: 'loadDashboard' },
                        { icon: 'fa-history', text: 'Visit History', action: 'loadPatientHistory' },
                        { icon: 'fa-file-pdf', text: 'Print Report', action: 'printPatientReport' }
                    ];
                    break;
            }

            sidebar.innerHTML = `
                <nav class="nav flex-column">
                    ${menuItems.map((item, index) => `
                        <a class="nav-link ${index === 0 ? 'active' : ''}" 
                           href="#" onclick="${item.action}(); return false;">
                            <i class="fas ${item.icon}"></i> ${item.text}
                        </a>
                    `).join('')}
                </nav>
            `;
        }

        function loadDashboard() {
            const content = document.getElementById('mainContent');
            let dashboardContent = `
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-hospital"></i> Clinic Information
                            </div>
                            <div class="card-body">
                                <h5>Beergeel Obstetrics and Gynecology Clinic</h5>
                                <p class="mb-1"><i class="fas fa-map-marker-alt"></i> Xero awr kasoo horjeedka Ayuub Restaurant inyar ka xiga dhanka Masjid Nuur</p>
                                <p class="mb-0"><i class="fas fa-phone"></i> Contact: 0634026635 (Mobile/WhatsApp)</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            switch(currentRole) {
                case 'reception':
                    const todayVisits = db.getTodayVisits().length;
                    const totalPatients = db.getAll('patients').length;
                    const todayPayments = db.getAll('payments').filter(p => 
                        new Date(p.created_date).toDateString() === new Date().toDateString()
                    ).reduce((sum, p) => sum + (p.amount || 0), 0);

                    dashboardContent += `
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card stat-card">
                                    <i class="fas fa-users fa-2x text-primary"></i>
                                    <div class="stat-number">${todayVisits}</div>
                                    <div class="stat-label">Today's Visits</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card stat-card">
                                    <i class="fas fa-user-injured fa-2x text-success"></i>
                                    <div class="stat-number">${totalPatients}</div>
                                    <div class="stat-label">Total Patients</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card stat-card">
                                    <i class="fas fa-money-bill-wave fa-2x text-warning"></i>
                                    <div class="stat-number">$${todayPayments.toFixed(2)}</div>
                                    <div class="stat-label">Today's Income</div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-bell"></i> Notice Board
                                    </div>
                                    <div class="card-body notice-board">
                                        <div class="notice-header">
                                            <span>Clinic Notice</span>
                                            <button class="btn btn-sm btn-primary" onclick="editNotice()">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                        </div>
                                        <div id="noticeContent">
                                            ${(() => {
                                                const notices = db.getAll('notices');
                                                return notices.length > 0 ? notices[0].content : 'No notice available. Click Edit to add one.';
                                            })()}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-list"></i> Quick Actions
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-primary mb-2 w-100" onclick="loadRegisterPatient()">
                                            <i class="fas fa-user-plus"></i> Register New Patient
                                        </button>
                                        <button class="btn btn-success mb-2 w-100" onclick="loadCreateVisit()">
                                            <i class="fas fa-stethoscope"></i> Create New Visit
                                        </button>
                                        <button class="btn btn-warning mb-2 w-100" onclick="loadFinancial()">
                                            <i class="fas fa-money-bill"></i> Record Payment
                                        </button>
                                        <button class="btn btn-info mb-2 w-100" onclick="loadPatientList()">
                                            <i class="fas fa-list"></i> View Patient List
                                        </button>
                                        <button class="btn btn-dark mb-2 w-100" onclick="loadAccountManagement()">
                                            <i class="fas fa-users-cog"></i> Account Management
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'doctor':
                    const queueCount = db.getQueueForDepartment('doctor').length;
                    dashboardContent += `
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-user-md"></i> Doctor Dashboard
                                    </div>
                                    <div class="card-body">
                                        <h4>Welcome Dr. ${currentUser.name?.split(' ')[1] || currentUser.name}</h4>
                                        <p>You have <span class="badge bg-danger">${queueCount}</span> patients waiting for consultation.</p>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary" onclick="loadDoctorQueue()">
                                                <i class="fas fa-users"></i> View Patient Queue
                                            </button>
                                            <button class="btn btn-success" onclick="loadPatientList()">
                                                <i class="fas fa-list"></i> View Patient List
                                            </button>
                                            <button class="btn btn-warning" onclick="loadFinancialView()">
                                                <i class="fas fa-money-bill"></i> View Financial
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'pharmacy':
                    const pharmacyQueue = db.getQueueForDepartment('pharmacy').length;
                    dashboardContent += `
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-pills"></i> Pharmacy Dashboard
                                    </div>
                                    <div class="card-body">
                                        <h4>Welcome ${currentUser.name}</h4>
                                        <p>You have <span class="badge bg-danger">${pharmacyQueue}</span> prescriptions waiting.</p>
                                        <button class="btn btn-primary" onclick="loadPharmacyQueue()">
                                            <i class="fas fa-users"></i> View Pharmacy Queue
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'lab':
                    const labQueue = db.getQueueForDepartment('lab').length;
                    dashboardContent += `
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-flask"></i> Laboratory Dashboard
                                    </div>
                                    <div class="card-body">
                                        <h4>Welcome ${currentUser.name}</h4>
                                        <p>You have <span class="badge bg-danger">${labQueue}</span> lab tests pending.</p>
                                        <button class="btn btn-primary" onclick="loadLabQueue()">
                                            <i class="fas fa-users"></i> View Lab Queue
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'patient':
                    const patientVisits = db.getPatientVisits(currentUser.id);
                    const lastVisit = patientVisits[patientVisits.length - 1];
                    
                    dashboardContent += `
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-user"></i> Patient Dashboard
                                    </div>
                                    <div class="card-body">
                                        <h4>Welcome ${currentUser.name}</h4>
                                        <div class="row mt-4">
                                            <div class="col-md-4">
                                                <div class="card stat-card">
                                                    <i class="fas fa-calendar-check fa-2x text-primary"></i>
                                                    <div class="stat-number">${patientVisits.length}</div>
                                                    <div class="stat-label">Total Visits</div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card stat-card">
                                                    <i class="fas fa-file-medical fa-2x text-success"></i>
                                                    <div class="stat-number">${db.getAll('prescriptions').filter(p => {
                                                        const visit = db.getById('visits', p.visit_id);
                                                        return visit && visit.patient_id == currentUser.id;
                                                    }).length}</div>
                                                    <div class="stat-label">Prescriptions</div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card stat-card">
                                                    <i class="fas fa-flask fa-2x text-warning"></i>
                                                    <div class="stat-number">${db.getAll('lab_requests').filter(l => {
                                                        const visit = db.getById('visits', l.visit_id);
                                                        return visit && visit.patient_id == currentUser.id;
                                                    }).length}</div>
                                                    <div class="stat-label">Lab Tests</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        ${lastVisit ? `
                                        <div class="alert alert-info mt-4">
                                            <h5>Last Visit Summary</h5>
                                            <p><strong>Date:</strong> ${new Date(lastVisit.created_date).toLocaleDateString()}</p>
                                            <p><strong>Vitals:</strong> BP: ${lastVisit.bp || 'N/A'}, PR: ${lastVisit.pr || 'N/A'}, Temp: ${lastVisit.temperature || 'N/A'}°C</p>
                                        </div>
                                        ` : '<div class="alert alert-warning mt-4">No previous visits found.</div>'}
                                        
                                        <button class="btn btn-primary" onclick="printPatientReport()">
                                            <i class="fas fa-file-pdf"></i> Download Medical Report
                                        </button>
                                        <button class="btn btn-success" onclick="loadPatientHistory()">
                                            <i class="fas fa-history"></i> View Visit History
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }

            content.innerHTML = dashboardContent;
        }

        function changePassword() {
            const currentPassword = prompt('Enter current password:');
            if (!currentPassword) return;
            
            // Check current password
            if (currentRole === 'patient') {
                if (currentUser.password !== currentPassword) {
                    alert('Current password is incorrect');
                    return;
                }
            } else {
                const user = db.getUserByUsername(currentUser.username);
                if (!user || user.password !== currentPassword) {
                    alert('Current password is incorrect');
                    return;
                }
            }
            
            const newPassword = prompt('Enter new password:');
            if (!newPassword) return;
            
            const confirmPassword = prompt('Confirm new password:');
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            // Update password
            if (currentRole === 'patient') {
                db.update('patients', currentUser.id, { password: newPassword });
                currentUser.password = newPassword;
            } else {
                db.update('users', currentUser.id, { password: newPassword });
                currentUser.password = newPassword;
            }
            
            alert('Password changed successfully!');
        }

        function loadAccountManagement() {
            if (currentRole !== 'reception') {
                alert('Access denied. Only reception can manage accounts.');
                return;
            }
            
            const content = document.getElementById('mainContent');
            const users = db.getAll('users');
            const patients = db.getAll('patients');
            
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-users-cog"></i> Account Management
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="accountTabs">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" onclick="showAccountTab('staff')">Staff Accounts</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="showAccountTab('patients')">Patient Accounts</a>
                            </li>
                        </ul>
                        
                        <div class="tab-content mt-3">
                            <div id="staffTab" class="tab-pane fade show active">
                                <h5>Staff Accounts (${users.length})</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Name</th>
                                                <th>Username</th>
                                                <th>Role</th>
                                                <th>Mobile</th>
                                                <th>Password</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${users.map(user => `
                                                <tr>
                                                    <td>${user.id}</td>
                                                    <td>${user.name}</td>
                                                    <td>${user.username}</td>
                                                    <td><span class="badge bg-info">${user.role}</span></td>
                                                    <td>${user.mobile}</td>
                                                    <td>${user.password}</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-warning" onclick="resetPassword('staff', ${user.id})">
                                                            <i class="fas fa-key"></i> Reset Password
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div id="patientsTab" class="tab-pane fade">
                                <h5>Patient Accounts (${patients.length})</h5>
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="searchPatientAccounts" 
                                           placeholder="Search by name or mobile" onkeyup="filterPatientAccounts()">
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Name</th>
                                                <th>Mobile</th>
                                                <th>Age/Sex</th>
                                                <th>Password</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="patientAccountsTable">
                                            ${patients.map(patient => `
                                                <tr>
                                                    <td>${patient.id}</td>
                                                    <td>${patient.name}</td>
                                                    <td>${patient.mobile}</td>
                                                    <td>${patient.age} yrs / ${patient.sex}</td>
                                                    <td>${patient.password}</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-warning" onclick="resetPassword('patient', ${patient.id})">
                                                            <i class="fas fa-key"></i> Reset Password
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showAccountTab(tabName) {
            // Hide all tabs
            ['staffTab', 'patientsTab'].forEach(tab => {
                document.getElementById(tab)?.classList.remove('show', 'active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab')?.classList.add('show', 'active');
            
            // Update tab navigation
            const tabLinks = document.querySelectorAll('#accountTabs .nav-link');
            tabLinks.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        function filterPatientAccounts() {
            const searchTerm = document.getElementById('searchPatientAccounts').value;
            const patients = db.searchPatients(searchTerm);
            const tableBody = document.getElementById('patientAccountsTable');
            
            tableBody.innerHTML = patients.map(patient => `
                <tr>
                    <td>${patient.id}</td>
                    <td>${patient.name}</td>
                    <td>${patient.mobile}</td>
                    <td>${patient.age} yrs / ${patient.sex}</td>
                    <td>${patient.password}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="resetPassword('patient', ${patient.id})">
                            <i class="fas fa-key"></i> Reset Password
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function resetPassword(type, id) {
            const newPassword = prompt('Enter new password (default: 1234):', '1234');
            if (!newPassword) return;
            
            if (type === 'staff') {
                const user = db.getById('users', id);
                if (user) {
                    db.update('users', id, { password: newPassword });
                    alert(`Password reset for ${user.name}. New password: ${newPassword}`);
                    loadAccountManagement();
                }
            } else if (type === 'patient') {
                const patient = db.getById('patients', id);
                if (patient) {
                    db.update('patients', id, { password: newPassword });
                    alert(`Password reset for ${patient.name}. New password: ${newPassword}`);
                    loadAccountManagement();
                }
            }
        }

        function loadDoctorQueue() {
            const content = document.getElementById('mainContent');
            const queue = db.getQueueForDepartment('doctor');
            
            content.innerHTML = `
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-users"></i> Doctor Queue
                            <span class="badge bg-danger ms-2">${queue.length} Waiting</span>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="loadPatientList()">
                                <i class="fas fa-list"></i> Select from Patient List
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        ${queue.length === 0 ? 
                            '<p class="text-muted">No patients in queue.</p>' : 
                            queue.map(item => {
                                const patient = item.patient;
                                const visit = item.visit;
                                const consultation = item.consultation;
                                const queueItem = db.getAll('queue').find(q => q.visit_id == visit?.id && q.department === 'doctor');
                                
                                let statusText = 'New';
                                let statusClass = 'status-waiting';
                                
                                if (consultation) {
                                    if (queueItem?.status === 'waiting_results') {
                                        statusText = 'Awaiting Results';
                                        statusClass = 'status-results';
                                    } else {
                                        statusText = 'In Progress';
                                        statusClass = 'status-inprogress';
                                    }
                                }
                                
                                return `
                                    <div class="patient-queue">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div style="flex-grow: 1;">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h5>${patient?.name || 'Unknown Patient'}</h5>
                                                        <p class="mb-1">
                                                            <i class="fas fa-phone"></i> ${patient?.mobile || 'N/A'} | 
                                                            <i class="fas fa-user"></i> ${patient?.sex || 'N/A'}, ${patient?.age || 'N/A'} yrs
                                                        </p>
                                                        <p class="mb-0">
                                                            <strong>Vitals:</strong> BP: ${visit?.bp || 'N/A'}, 
                                                            PR: ${visit?.pr || 'N/A'}, 
                                                            Temp: ${visit?.temperature || 'N/A'}°C
                                                        </p>
                                                    </div>
                                                    <div>
                                                        <span class="queue-status ${statusClass}">${statusText}</span>
                                                    </div>
                                                </div>
                                                ${consultation ? `
                                                <div class="mt-2">
                                                    <p class="mb-1"><strong>Previous Consultation:</strong></p>
                                                    <p class="mb-0 text-muted">${consultation.chief_complaint.substring(0, 100)}${consultation.chief_complaint.length > 100 ? '...' : ''}</p>
                                                </div>
                                                ` : ''}
                                            </div>
                                            <div class="ms-3">
                                                ${!consultation ? `
                                                <button class="btn btn-primary" onclick="startConsultation(${visit.id}, ${patient.id})">
                                                    <i class="fas fa-stethoscope"></i> Start Consultation
                                                </button>
                                                ` : `
                                                <div class="d-flex flex-column gap-2">
                                                    <button class="btn btn-success" onclick="continueConsultation(${visit.id}, ${patient.id})">
                                                        <i class="fas fa-edit"></i> Continue
                                                    </button>
                                                    ${queueItem?.status === 'waiting_results' ? `
                                                    <button class="btn btn-info" onclick="checkLabResults(${visit.id})">
                                                        <i class="fas fa-flask"></i> Check Results
                                                    </button>
                                                    ` : ''}
                                                </div>
                                                `}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')
                        }
                    </div>
                </div>
            `;
        }

        function startConsultation(visitId, patientId) {
            const patient = db.getById('patients', patientId);
            const visit = db.getById('visits', visitId);
            
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-stethoscope"></i> Consultation for ${patient.name}
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5>Patient Information</h5>
                                <p><strong>Name:</strong> ${patient.name}</p>
                                <p><strong>Age/Sex:</strong> ${patient.age} years, ${patient.sex}</p>
                                <p><strong>Mobile:</strong> ${patient.mobile}</p>
                            </div>
                            <div class="col-md-6">
                                <h5>Vital Signs</h5>
                                <p><strong>BP:</strong> ${visit.bp || 'N/A'}</p>
                                <p><strong>PR:</strong> ${visit.pr || 'N/A'} bpm</p>
                                <p><strong>Temperature:</strong> ${visit.temperature || 'N/A'}°C</p>
                                <p><strong>Weight/BMI:</strong> ${visit.weight || 'N/A'} kg / ${visit.bmi || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <form id="consultationForm">
                            <div class="mb-3">
                                <label class="form-label">Chief Complaint *</label>
                                <textarea class="form-control" id="chiefComplaint" rows="2" required></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">History of Present Illness</label>
                                <textarea class="form-control" id="history" rows="3"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Physical Examination</label>
                                <textarea class="form-control" id="physicalExam" rows="3"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Diagnosis</label>
                                <textarea class="form-control" id="diagnosis" rows="2"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Treatment Plan</label>
                                <textarea class="form-control" id="plan" rows="2"></textarea>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-header">Laboratory Requests</div>
                                <div class="card-body">
                                    <div class="row" id="labRequests">
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="CBC" id="test_cbc">
                                                <label class="form-check-label" for="test_cbc">CBC</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="Urinalysis" id="test_urinalysis">
                                                <label class="form-check-label" for="test_urinalysis">Urinalysis</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="Pregnancy Test" id="test_pregnancy">
                                                <label class="form-check-label" for="test_pregnancy">Pregnancy Test</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="Blood Glucose" id="test_glucose">
                                                <label class="form-check-label" for="test_glucose">Blood Glucose</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="HIV Test" id="test_hiv">
                                                <label class="form-check-label" for="test_hiv">HIV Test</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="Ultrasound" id="test_ultrasound">
                                                <label class="form-check-label" for="test_ultrasound">Ultrasound</label>
                                            </div>
                                        </div>
                                        <!-- New Hormone Tests -->
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="FSH" id="test_fsh">
                                                <label class="form-check-label" for="test_fsh">FSH</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="LH" id="test_lh">
                                                <label class="form-check-label" for="test_lh">LH</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="E2 (Estradiol)" id="test_e2">
                                                <label class="form-check-label" for="test_e2">E2 (Estradiol)</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="PROLACTIN" id="test_prolactin">
                                                <label class="form-check-label" for="test_prolactin">PROLACTIN</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="TSH" id="test_tsh">
                                                <label class="form-check-label" for="test_tsh">TSH</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="T3" id="test_t3">
                                                <label class="form-check-label" for="test_t3">T3</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="T4" id="test_t4">
                                                <label class="form-check-label" for="test_t4">T4</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="BHCG (Pregnancy)" id="test_bhcg">
                                                <label class="form-check-label" for="test_bhcg">BHCG (Pregnancy)</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="sCr (Creatinine)" id="test_scr">
                                                <label class="form-check-label" for="test_scr">sCr (Creatinine)</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="BUN" id="test_bun">
                                                <label class="form-check-label" for="test_bun">BUN</label>
                                            </div>
                                        </div>
                                        <div class="col-md-12 mt-2">
                                            <label class="form-label">Other Tests</label>
                                            <input type="text" class="form-control" id="otherTests" 
                                                   placeholder="Specify other tests">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-header">Prescription</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Prescribed Drugs</label>
                                        <textarea class="form-control" id="prescription" rows="3" 
                                                  placeholder="Enter prescribed drugs and dosage"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" onclick="saveConsultation(${visitId})">
                                    <i class="fas fa-save"></i> Save & Wait for Results
                                </button>
                                <button type="button" class="btn btn-success" onclick="completeConsultation(${visitId})">
                                    <i class="fas fa-check-circle"></i> Complete Consultation
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="loadDoctorQueue()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function saveConsultation(visitId) {
            const chiefComplaint = document.getElementById('chiefComplaint').value;
            const history = document.getElementById('history').value;
            const physicalExam = document.getElementById('physicalExam').value;
            const diagnosis = document.getElementById('diagnosis').value;
            const plan = document.getElementById('plan').value;
            
            // Get selected lab tests
            const selectedTests = Array.from(document.querySelectorAll('.lab-test:checked'))
                .map(cb => cb.value);
            const otherTests = document.getElementById('otherTests').value;
            const allTests = [...selectedTests, ...(otherTests ? [otherTests] : [])];
            
            const prescription = document.getElementById('prescription').value;

            if (!chiefComplaint) {
                alert('Please enter chief complaint');
                return;
            }

            // Check if consultation already exists
            let consultation = db.getConsultationForVisit(visitId);
            
            if (consultation) {
                // Update existing consultation
                db.update('consultations', consultation.id, {
                    chief_complaint: chiefComplaint,
                    history,
                    physical_exam: physicalExam,
                    diagnosis,
                    plan
                });
            } else {
                // Save new consultation
                consultation = db.add('consultations', {
                    visit_id: visitId,
                    doctor_id: currentUser.id,
                    chief_complaint: chiefComplaint,
                    history,
                    physical_exam: physicalExam,
                    diagnosis,
                    plan
                });
            }

            // Save lab requests if any
            if (allTests.length > 0) {
                const existingLabRequest = db.getAll('lab_requests').find(l => l.visit_id == visitId);
                if (existingLabRequest) {
                    db.update('lab_requests', existingLabRequest.id, {
                        tests: allTests.join(', '),
                        status: 'pending'
                    });
                } else {
                    db.add('lab_requests', {
                        visit_id: visitId,
                        tests: allTests.join(', '),
                        status: 'pending'
                    });
                }
                
                // Add to lab queue if not already there
                const existingLabQueue = db.getAll('queue').find(q => q.visit_id == visitId && q.department === 'lab');
                if (!existingLabQueue) {
                    db.add('queue', {
                        visit_id: visitId,
                        department: 'lab',
                        status: 'waiting'
                    });
                }
                
                // Update doctor queue status to waiting for results
                const doctorQueueItem = db.getAll('queue').find(q => q.visit_id == visitId && q.department === 'doctor');
                if (doctorQueueItem) {
                    db.update('queue', doctorQueueItem.id, { status: 'waiting_results' });
                }
            }

            // Save prescription if any
            if (prescription.trim()) {
                const existingPrescription = db.getAll('prescriptions').find(p => p.visit_id == visitId);
                if (existingPrescription) {
                    db.update('prescriptions', existingPrescription.id, {
                        drugs: prescription,
                        status: 'pending'
                    });
                } else {
                    db.add('prescriptions', {
                        visit_id: visitId,
                        drugs: prescription,
                        status: 'pending'
                    });
                }
                
                // Add to pharmacy queue if not already there
                const existingPharmacyQueue = db.getAll('queue').find(q => q.visit_id == visitId && q.department === 'pharmacy');
                if (!existingPharmacyQueue) {
                    db.add('queue', {
                        visit_id: visitId,
                        department: 'pharmacy',
                        status: 'waiting'
                    });
                }
            }

            alert('Consultation saved successfully! Patient will remain in queue awaiting results.');
            loadDoctorQueue();
        }

        function completeConsultation(visitId) {
            const chiefComplaint = document.getElementById('chiefComplaint')?.value;
            const history = document.getElementById('history')?.value;
            const physicalExam = document.getElementById('physicalExam')?.value;
            const diagnosis = document.getElementById('diagnosis')?.value;
            const plan = document.getElementById('plan')?.value;
            
            // If form exists, save it first
            if (chiefComplaint) {
                saveConsultation(visitId);
            }
            
            // Update visit status
            db.update('visits', visitId, { status: 'completed' });
            
            // Remove from doctor queue
            const queueItems = db.getAll('queue').filter(q => 
                q.visit_id == visitId && q.department === 'doctor'
            );
            queueItems.forEach(item => {
                db.update('queue', item.id, { status: 'completed' });
            });
            
            alert('Consultation completed! Patient removed from queue.');
            loadDoctorQueue();
        }

        function continueConsultation(visitId, patientId) {
            const patient = db.getById('patients', patientId);
            const visit = db.getById('visits', visitId);
            const consultation = db.getConsultationForVisit(visitId);
            const labRequest = db.getAll('lab_requests').find(l => l.visit_id == visitId);
            const prescription = db.getAll('prescriptions').find(p => p.visit_id == visitId);
            const labResults = labRequest?.results || '';
            
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-stethoscope"></i> Continue Consultation for ${patient.name}
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5>Patient Information</h5>
                                <p><strong>Name:</strong> ${patient.name}</p>
                                <p><strong>Age/Sex:</strong> ${patient.age} years, ${patient.sex}</p>
                                <p><strong>Mobile:</strong> ${patient.mobile}</p>
                            </div>
                            <div class="col-md-6">
                                <h5>Vital Signs</h5>
                                <p><strong>BP:</strong> ${visit.bp || 'N/A'}</p>
                                <p><strong>PR:</strong> ${visit.pr || 'N/A'} bpm</p>
                                <p><strong>Temperature:</strong> ${visit.temperature || 'N/A'}°C</p>
                                <p><strong>Weight/BMI:</strong> ${visit.weight || 'N/A'} kg / ${visit.bmi || 'N/A'}</p>
                            </div>
                        </div>
                        
                        ${labResults ? `
                        <div class="alert alert-info mb-4">
                            <h5><i class="fas fa-flask"></i> Laboratory Results</h5>
                            <p>${labResults}</p>
                        </div>
                        ` : ''}
                        
                        <form id="consultationForm">
                            <div class="mb-3">
                                <label class="form-label">Chief Complaint *</label>
                                <textarea class="form-control" id="chiefComplaint" rows="2" required>${consultation?.chief_complaint || ''}</textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">History of Present Illness</label>
                                <textarea class="form-control" id="history" rows="3">${consultation?.history || ''}</textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Physical Examination</label>
                                <textarea class="form-control" id="physicalExam" rows="3">${consultation?.physical_exam || ''}</textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Diagnosis</label>
                                <textarea class="form-control" id="diagnosis" rows="2">${consultation?.diagnosis || ''}</textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Treatment Plan</label>
                                <textarea class="form-control" id="plan" rows="2">${consultation?.plan || ''}</textarea>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-header">Additional Laboratory Requests</div>
                                <div class="card-body">
                                    <div class="row" id="labRequests">
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="CBC" id="test_cbc">
                                                <label class="form-check-label" for="test_cbc">CBC</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="Urinalysis" id="test_urinalysis">
                                                <label class="form-check-label" for="test_urinalysis">Urinalysis</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="Pregnancy Test" id="test_pregnancy">
                                                <label class="form-check-label" for="test_pregnancy">Pregnancy Test</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="FSH" id="test_fsh">
                                                <label class="form-check-label" for="test_fsh">FSH</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="LH" id="test_lh">
                                                <label class="form-check-label" for="test_lh">LH</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="E2 (Estradiol)" id="test_e2">
                                                <label class="form-check-label" for="test_e2">E2 (Estradiol)</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="PROLACTIN" id="test_prolactin">
                                                <label class="form-check-label" for="test_prolactin">PROLACTIN</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input lab-test" type="checkbox" value="TSH" id="test_tsh">
                                                <label class="form-check-label" for="test_tsh">TSH</label>
                                            </div>
                                        </div>
                                        <div class="col-md-12 mt-2">
                                            <label class="form-label">Other Tests</label>
                                            <input type="text" class="form-control" id="otherTests" 
                                                   placeholder="Specify other tests">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-header">Prescription</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Prescribed Drugs</label>
                                        <textarea class="form-control" id="prescription" rows="3" 
                                                  placeholder="Enter prescribed drugs and dosage">${prescription?.drugs || ''}</textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" onclick="saveConsultation(${visitId})">
                                    <i class="fas fa-save"></i> Save & Continue Waiting
                                </button>
                                <button type="button" class="btn btn-success" onclick="completeConsultation(${visitId})">
                                    <i class="fas fa-check-circle"></i> Complete Consultation
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="loadDoctorQueue()">
                                    <i class="fas fa-times"></i> Back to Queue
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function checkLabResults(visitId) {
            const labRequest = db.getAll('lab_requests').find(l => l.visit_id == visitId);
            
            if (labRequest?.results) {
                alert(`Laboratory Results:\n\n${labRequest.results}\n\nYou can now continue consultation and complete it.`);
            } else {
                alert('Laboratory results are not available yet.');
            }
        }

        function editConsultationFromPatientList(visitId, patientId) {
            const consultation = db.getConsultationForVisit(visitId);
            
            if (consultation) {
                continueConsultation(visitId, patientId);
            } else {
                startConsultation(visitId, patientId);
            }
        }

        function loadPatientList() {
            const content = document.getElementById('mainContent');
            const patients = db.getAll('patients');
            
            content.innerHTML = `
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-list"></i> Patient List
                            <span class="badge bg-primary ms-2">${patients.length} Patients</span>
                        </div>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control" id="searchPatientList" 
                                   placeholder="Search by name or mobile" onkeyup="filterPatientList()" style="width: 250px;">
                            ${currentRole === 'reception' ? `
                            <button class="btn btn-primary" onclick="loadRegisterPatient()">
                                <i class="fas fa-user-plus"></i> Add Patient
                            </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Mobile</th>
                                        <th>Age/Sex</th>
                                        <th>Registered Date</th>
                                        <th>Visits</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="patientListTable">
                                    ${patients.map(patient => {
                                        const visits = db.getPatientVisits(patient.id);
                                        const latestVisit = visits[visits.length - 1];
                                        
                                        return `
                                            <tr>
                                                <td>${patient.id}</td>
                                                <td>${patient.name}</td>
                                                <td>${patient.mobile}</td>
                                                <td>${patient.age} yrs / ${patient.sex}</td>
                                                <td>${new Date(patient.created_date).toLocaleDateString()}</td>
                                                <td><span class="badge bg-info">${visits.length}</span></td>
                                                <td>
                                                    <div class="btn-group">
                                                        ${currentRole === 'reception' ? `
                                                        <button class="btn btn-sm btn-primary" onclick="createVisitForPatient(${patient.id})">
                                                            <i class="fas fa-stethoscope"></i> Visit
                                                        </button>
                                                        <button class="btn btn-sm btn-success" onclick="recordPaymentForPatient(${patient.id})">
                                                            <i class="fas fa-money-bill"></i> Payment
                                                        </button>
                                                        ` : ''}
                                                        ${currentRole === 'doctor' && latestVisit ? `
                                                        <button class="btn btn-sm btn-warning" onclick="editConsultationFromPatientList(${latestVisit.id}, ${patient.id})">
                                                            <i class="fas fa-edit"></i> Edit Consultation
                                                        </button>
                                                        ` : ''}
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadFinancialView() {
            const content = document.getElementById('mainContent');
            const today = new Date().toDateString();
            
            const todayPayments = db.getAll('payments').filter(p => 
                new Date(p.created_date).toDateString() === today
            ).reduce((sum, p) => sum + (p.amount || 0), 0);
            const todayExpenses = db.getAll('expenses').filter(e => 
                new Date(e.created_date).toDateString() === today
            ).reduce((sum, e) => sum + (e.amount || 0), 0);
            
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-money-bill-wave"></i> Financial Overview
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-calendar-day"></i> Today's Financial Summary
                                    </div>
                                    <div class="card-body">
                                        <div class="text-center mb-4">
                                            <h3>$${todayPayments.toFixed(2)}</h3>
                                            <p class="text-muted">Today's Income</p>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Total Payments:</span>
                                            <span class="text-success">$${todayPayments.toFixed(2)}</span>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Total Expenses:</span>
                                            <span class="text-danger">$${todayExpenses.toFixed(2)}</span>
                                        </div>
                                        
                                        <hr>
                                        
                                        <div class="d-flex justify-content-between mb-2">
                                            <strong>Net Income:</strong>
                                            <strong class="${(todayPayments - todayExpenses) >= 0 ? 'text-success' : 'text-danger'}">
                                                $${(todayPayments - todayExpenses).toFixed(2)}
                                            </strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-list"></i> Recent Transactions
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Time</th>
                                                        <th>Type</th>
                                                        <th>Amount</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="recentTransactions">
                                                    ${(() => {
                                                        const payments = db.getAll('payments');
                                                        const expenses = db.getAll('expenses');
                                                        const patients = db.getAll('patients');
                                                        
                                                        const transactions = [
                                                            ...payments.map(p => ({
                                                                ...p, 
                                                                type: 'Payment',
                                                                patient_name: patients.find(pat => pat.id == p.patient_id)?.name || 'Unknown'
                                                            })),
                                                            ...expenses.map(e => ({
                                                                ...e, 
                                                                type: 'Expense',
                                                                patient_name: 'N/A'
                                                            }))
                                                        ].sort((a, b) => new Date(b.created_date) - new Date(a.created_date))
                                                        .slice(0, 10);
                                                        
                                                        return transactions.map(t => `
                                                            <tr class="${t.type === 'Payment' ? 'table-success' : 'table-danger'}">
                                                                <td>${new Date(t.created_date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                                                                <td>${t.type}</td>
                                                                <td>$${t.amount.toFixed(2)}</td>
                                                            </tr>
                                                        `).join('');
                                                    })()}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            Doctor's view only shows financial summaries. For detailed management, please contact reception.
                        </div>
                    </div>
                </div>
            `;
        }

        // Fixed Notice Functions
        function editNotice() {
            const notices = db.getAll('notices');
            const currentNotice = notices[0];
            
            if (!currentNotice) {
                // Create a new notice if none exists
                const newContent = prompt('Create new notice:');
                if (newContent !== null && newContent.trim() !== '') {
                    db.add('notices', {
                        content: newContent,
                        updated_by: currentUser.name || currentUser.username
                    });
                    alert('Notice created successfully!');
                    updateHomePageNotice();
                    loadDashboard(); // Reload to show updated notice
                }
                return;
            }
            
            const newContent = prompt('Edit notice content:', currentNotice.content);
            if (newContent !== null && newContent.trim() !== '') {
                db.update('notices', currentNotice.id, {
                    content: newContent,
                    updated_by: currentUser.name || currentUser.username
                });
                alert('Notice updated successfully!');
                updateHomePageNotice();
                loadDashboard(); // Reload to show updated notice
            }
        }

        function loadNoticeBoard() {
            const content = document.getElementById('mainContent');
            const notices = db.getAll('notices');
            const currentNotice = notices[0];
            
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-bell"></i> Notice Board Management
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            This notice will appear on the home page and reception dashboard.
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Notice Content *</label>
                            <textarea class="form-control" id="noticeText" rows="6" placeholder="Enter notice content..." required>${currentNotice?.content || ''}</textarea>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="saveNotice()">
                                <i class="fas fa-save"></i> Save Notice
                            </button>
                            <button class="btn btn-secondary" onclick="loadDashboard()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            ${currentNotice ? `
                            <button class="btn btn-danger" onclick="deleteNotice()">
                                <i class="fas fa-trash"></i> Delete Notice
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function saveNotice() {
            const content = document.getElementById('noticeText').value.trim();
            
            if (!content) {
                alert('Please enter notice content');
                return;
            }
            
            const notices = db.getAll('notices');
            
            if (notices.length > 0) {
                // Update existing notice
                const success = db.update('notices', notices[0].id, {
                    content: content,
                    updated_by: currentUser.name || currentUser.username
                });
                
                if (success) {
                    alert('Notice updated successfully!');
                } else {
                    alert('Failed to update notice');
                }
            } else {
                // Create new notice
                db.add('notices', {
                    content: content,
                    updated_by: currentUser.name || currentUser.username
                });
                alert('Notice created successfully!');
            }
            
            // Update home page notice immediately
            updateHomePageNotice();
            
            // Go back to dashboard
            loadDashboard();
        }

        function deleteNotice() {
            if (confirm('Are you sure you want to delete the notice? This cannot be undone.')) {
                const notices = db.getAll('notices');
                if (notices.length > 0) {
                    db.delete('notices', notices[0].id);
                    alert('Notice deleted successfully!');
                    
                    // Update home page notice
                    updateHomePageNotice();
                    
                    loadDashboard();
                }
            }
        }

        // Rest of the functions remain the same as your working code...
        // (Register Patient, Create Visit, Financial, Pharmacy, Lab, etc.)
        // These functions should be included from your original code

        function createVisitForPatient(patientId) {
            loadCreateVisit();
            setTimeout(() => {
                selectPatientForVisit(patientId);
            }, 100);
        }

        function recordPaymentForPatient(patientId) {
            loadFinancial();
            setTimeout(() => {
                const patient = db.getById('patients', patientId);
                document.getElementById('paymentPatientMobile').value = patient.mobile;
                searchPatientForPayment();
            }, 100);
        }

        function loadCreateVisit() {
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-search"></i> Search Patient
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="searchPatient" 
                                           placeholder="Search by name or mobile" onkeyup="searchPatients()">
                                </div>
                                <div id="patientSearchResults" style="max-height: 400px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-stethoscope"></i> Create Visit
                            </div>
                            <div class="card-body">
                                <div id="visitFormContainer">
                                    <p class="text-muted">Select a patient to create visit</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            searchPatients();
        }

        function searchPatients() {
            const searchTerm = document.getElementById('searchPatient').value.toLowerCase();
            const patients = db.getAll('patients');
            const resultsDiv = document.getElementById('patientSearchResults');
            
            const filteredPatients = patients.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || 
                p.mobile.includes(searchTerm)
            ).slice(0, 10);
            
            if (filteredPatients.length === 0) {
                resultsDiv.innerHTML = '<p class="text-muted">No patients found</p>';
                return;
            }
            
            resultsDiv.innerHTML = filteredPatients.map(patient => `
                <div class="patient-queue" onclick="selectPatientForVisit(${patient.id})">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${patient.name}</h6>
                            <p class="mb-0 text-muted">
                                <i class="fas fa-phone"></i> ${patient.mobile} | 
                                <i class="fas fa-user"></i> ${patient.sex}, ${patient.age} yrs
                            </p>
                        </div>
                        <button class="btn btn-sm btn-primary">
                            <i class="fas fa-plus"></i> Visit
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function selectPatientForVisit(patientId) {
            const patient = db.getById('patients', patientId);
            const content = document.getElementById('visitFormContainer');
            
            content.innerHTML = `
                <h5>Creating Visit for: ${patient.name}</h5>
                <form id="vitalSignsForm">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Blood Pressure</label>
                                <input type="text" class="form-control" id="bp" placeholder="e.g., 120/80">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Pulse Rate</label>
                                <input type="number" class="form-control" id="pr" placeholder="bpm">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Temperature (°C)</label>
                                <input type="number" step="0.1" class="form-control" id="temperature" placeholder="36.5">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Weight (kg)</label>
                                <input type="number" step="0.1" class="form-control" id="weight" placeholder="kg">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">SPO₂</label>
                                <input type="number" class="form-control" id="spo" placeholder="%" min="0" max="100">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Height (cm) - Optional</label>
                                <input type="number" class="form-control" id="height" placeholder="cm">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">BMI</label>
                                <input type="text" class="form-control" id="bmi" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="addToDoctorQueue" checked>
                            <label class="form-check-label" for="addToDoctorQueue">
                                Add to Doctor Queue
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" onclick="saveVisit(${patientId})">
                            <i class="fas fa-save"></i> Save Visit
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveVisitAndAddPayment(${patientId})">
                            <i class="fas fa-money-bill"></i> Save & Add Payment
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="loadCreateVisit()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            `;

            // Add BMI calculation
            document.getElementById('weight').addEventListener('input', calculateBMI);
            document.getElementById('height').addEventListener('input', calculateBMI);
        }

        function calculateBMI() {
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value);
            
            if (weight && height && height > 0) {
                const heightM = height / 100;
                const bmi = weight / (heightM * heightM);
                document.getElementById('bmi').value = bmi.toFixed(2);
            } else {
                document.getElementById('bmi').value = '';
            }
        }

        function saveVisit(patientId) {
            const bp = document.getElementById('bp').value;
            const pr = document.getElementById('pr').value;
            const temperature = document.getElementById('temperature').value;
            const weight = document.getElementById('weight').value;
            const spo = document.getElementById('spo').value;
            const bmi = document.getElementById('bmi').value;
            const height = document.getElementById('height').value;
            const addToQueue = document.getElementById('addToDoctorQueue').checked;

            const visit = db.add('visits', {
                patient_id: patientId,
                bp,
                pr,
                temperature,
                weight: weight ? parseFloat(weight) : null,
                height: height ? parseFloat(height) : null,
                bmi: bmi ? parseFloat(bmi) : null,
                spo,
                status: 'in_progress',
                created_by: currentUser.id
            });

            if (addToQueue) {
                db.add('queue', {
                    visit_id: visit.id,
                    department: 'doctor',
                    status: 'waiting'
                });
                alert('Visit created and patient added to doctor queue!');
            } else {
                alert('Visit created successfully!');
            }

            loadDashboard();
        }

        function saveVisitAndAddPayment(patientId) {
            saveVisit(patientId);
            loadFinancial();
        }

        function loadFinancial() {
            const content = document.getElementById('mainContent');
            const currencies = [
                'Zaad Shilling', 'Zaad USD', 'Edahab Shilling', 'Edahab USD',
                'Cash Shilling', 'Cash USD'
            ];

            content.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-money-bill-wave"></i> Financial Management
                            </div>
                            <div class="card-body">
                                <ul class="nav nav-tabs" id="financialTabs">
                                    <li class="nav-item">
                                        <a class="nav-link active" href="#" onclick="showFinancialTab('receivePayment')">
                                            Receive Payment
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" onclick="showFinancialTab('recordExpense')">
                                            Record Expense
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" onclick="showFinancialTab('quickPatientPayment')">
                                            Quick Patient Payment
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" onclick="showFinancialTab('viewTransactions')">
                                            View Transactions
                                        </a>
                                    </li>
                                </ul>
                                
                                <div class="tab-content mt-3">
                                    <div id="receivePaymentTab" class="tab-pane fade show active">
                                        <form id="paymentForm">
                                            <div class="mb-3">
                                                <label class="form-label">Select Patient</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="paymentPatientMobile" 
                                                           placeholder="Enter mobile number">
                                                    <button class="btn btn-outline-secondary" type="button" onclick="searchPatientForPayment()">
                                                        <i class="fas fa-search"></i> Search
                                                    </button>
                                                </div>
                                                <div id="paymentPatientInfo" class="mt-2"></div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Amount *</label>
                                                        <input type="number" class="form-control" id="paymentAmount" required>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Currency *</label>
                                                        <select class="form-select" id="paymentCurrency" required>
                                                            ${currencies.map(c => `<option value="${c}">${c}</option>`).join('')}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Payment Type</label>
                                                <select class="form-select" id="paymentType">
                                                    <option value="consultation">Consultation Fee</option>
                                                    <option value="ultrasound">Ultrasound</option>
                                                    <option value="investigation">Investigation</option>
                                                    <option value="drugs">Drugs</option>
                                                    <option value="lab_tests">Lab Tests</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Description</label>
                                                <textarea class="form-control" id="paymentDescription" rows="2"></textarea>
                                            </div>
                                            
                                            <button type="button" class="btn btn-primary" onclick="recordPayment()">
                                                <i class="fas fa-save"></i> Record Payment
                                            </button>
                                        </form>
                                    </div>
                                    
                                    <div id="recordExpenseTab" class="tab-pane fade">
                                        <form id="expenseForm">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Amount *</label>
                                                        <input type="number" class="form-control" id="expenseAmount" required>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Currency *</label>
                                                        <select class="form-select" id="expenseCurrency" required>
                                                            ${currencies.map(c => `<option value="${c}">${c}</option>`).join('')}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Category</label>
                                                <select class="form-select" id="expenseCategory">
                                                    <option value="electricity">Electricity</option>
                                                    <option value="rent">Rent</option>
                                                    <option value="water">Water</option>
                                                    <option value="sanitation">Sanitation</option>
                                                    <option value="salary">Salary</option>
                                                    <option value="lab_commission">Lab Commission</option>
                                                    <option value="doctor_payment">Doctor Payment</option>
                                                    <option value="pharmacy_stock">Pharmacy Stock</option>
                                                    <option value="maintenance">Maintenance</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Description</label>
                                                <textarea class="form-control" id="expenseDescription" rows="2"></textarea>
                                            </div>
                                            
                                            <button type="button" class="btn btn-primary" onclick="recordExpense()">
                                                <i class="fas fa-save"></i> Record Expense
                                            </button>
                                        </form>
                                    </div>
                                    
                                    <div id="quickPatientPaymentTab" class="tab-pane fade">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> 
                                            Register a quick payment for a patient not in the system
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Patient Name *</label>
                                                    <input type="text" class="form-control" id="quickPatientName" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Mobile Number</label>
                                                    <input type="text" class="form-control" id="quickPatientMobile" 
                                                           placeholder="Optional for new patients">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Amount *</label>
                                                    <input type="number" class="form-control" id="quickPaymentAmount" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Currency *</label>
                                                    <select class="form-select" id="quickPaymentCurrency" required>
                                                        ${currencies.map(c => `<option value="${c}">${c}</option>`).join('')}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Payment Type</label>
                                            <select class="form-select" id="quickPaymentType">
                                                <option value="consultation">Consultation Fee</option>
                                                <option value="ultrasound">Ultrasound</option>
                                                <option value="investigation">Investigation</option>
                                                <option value="drugs">Drugs</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Description</label>
                                            <textarea class="form-control" id="quickPaymentDescription" rows="2"></textarea>
                                        </div>
                                        
                                        <button type="button" class="btn btn-success" onclick="recordQuickPayment()">
                                            <i class="fas fa-bolt"></i> Record Quick Payment
                                        </button>
                                    </div>
                                    
                                    <div id="viewTransactionsTab" class="tab-pane fade">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Type</th>
                                                        <th>Description</th>
                                                        <th>Patient</th>
                                                        <th>Amount</th>
                                                        <th>Currency</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="transactionsTable">
                                                    <!-- Transactions will be loaded here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-line"></i> Today's Summary
                            </div>
                            <div class="card-body">
                                <div id="financialSummary">
                                    <!-- Summary will be loaded here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <i class="fas fa-exchange-alt"></i> Quick Actions
                            </div>
                            <div class="card-body">
                                <button class="btn btn-primary w-100 mb-2" onclick="loadPatientList()">
                                    <i class="fas fa-list"></i> Select from Patient List
                                </button>
                                <button class="btn btn-success w-100 mb-2" onclick="loadRegisterPatient()">
                                    <i class="fas fa-user-plus"></i> Register New Patient
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            loadFinancialSummary();
            loadTransactions();
            showFinancialTab('receivePayment');
        }

        function showFinancialTab(tabName) {
            // Hide all tabs
            ['receivePaymentTab', 'recordExpenseTab', 'quickPatientPaymentTab', 'viewTransactionsTab'].forEach(tab => {
                document.getElementById(tab)?.classList.remove('show', 'active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab')?.classList.add('show', 'active');
            
            // Update tab navigation
            const tabLinks = document.querySelectorAll('#financialTabs .nav-link');
            tabLinks.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        function loadFinancialSummary() {
            const today = new Date().toDateString();
            const payments = db.getAll('payments').filter(p => 
                new Date(p.created_date).toDateString() === today
            );
            const expenses = db.getAll('expenses').filter(e => 
                new Date(e.created_date).toDateString() === today
            );
            
            const totalIncome = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const netIncome = totalIncome - totalExpenses;

            const summaryDiv = document.getElementById('financialSummary');
            if (summaryDiv) {
                summaryDiv.innerHTML = `
                    <div class="text-center mb-4">
                        <h3>$${totalIncome.toFixed(2)}</h3>
                        <p class="text-muted">Today's Income</p>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Payments:</span>
                        <span class="text-success">$${totalIncome.toFixed(2)}</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Expenses:</span>
                        <span class="text-danger">$${totalExpenses.toFixed(2)}</span>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <strong>Net Income:</strong>
                        <strong class="${netIncome >= 0 ? 'text-success' : 'text-danger'}">
                            $${netIncome.toFixed(2)}
                        </strong>
                    </div>
                `;
            }
        }

        function loadTransactions() {
            const payments = db.getAll('payments');
            const expenses = db.getAll('expenses');
            const patients = db.getAll('patients');
            
            // Combine and sort by date
            const transactions = [
                ...payments.map(p => ({
                    ...p, 
                    type: 'Payment',
                    patient_name: patients.find(pat => pat.id == p.patient_id)?.name || 'Unknown'
                })),
                ...expenses.map(e => ({
                    ...e, 
                    type: 'Expense',
                    patient_name: 'N/A'
                }))
            ].sort((a, b) => new Date(b.created_date) - new Date(a.created_date))
            .slice(0, 20);

            const tableBody = document.getElementById('transactionsTable');
            if (tableBody) {
                tableBody.innerHTML = transactions.map(t => `
                    <tr class="${t.type === 'Payment' ? 'table-success' : 'table-danger'}">
                        <td>${new Date(t.created_date).toLocaleDateString()}</td>
                        <td>${t.type}</td>
                        <td>${t.description || t.category || t.payment_type || 'No description'}</td>
                        <td>${t.patient_name}</td>
                        <td>${t.amount}</td>
                        <td><span class="currency-badge bg-info">${t.currency}</span></td>
                    </tr>
                `).join('');
            }
        }

        function searchPatientForPayment() {
            const mobile = document.getElementById('paymentPatientMobile').value;
            const patient = db.findPatientByMobile(mobile);
            const infoDiv = document.getElementById('paymentPatientInfo');
            
            if (patient) {
                infoDiv.innerHTML = `
                    <div class="alert alert-success py-2">
                        <i class="fas fa-check-circle"></i> 
                        Patient found: ${patient.name} (${patient.sex}, ${patient.age} yrs)
                    </div>
                `;
            } else {
                infoDiv.innerHTML = `
                    <div class="alert alert-warning py-2">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Patient not found. Please check mobile number or use "Quick Patient Payment" tab.
                    </div>
                `;
            }
        }

        function recordPayment() {
            const mobile = document.getElementById('paymentPatientMobile').value;
            const patient = db.findPatientByMobile(mobile);
            
            if (!patient) {
                alert('Please find a valid patient first');
                return;
            }

            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const currency = document.getElementById('paymentCurrency').value;
            const paymentType = document.getElementById('paymentType').value;
            const description = document.getElementById('paymentDescription').value;

            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            // Get latest visit for this patient
            const visits = db.getPatientVisits(patient.id);
            const latestVisit = visits[visits.length - 1];

            const payment = db.add('payments', {
                patient_id: patient.id,
                visit_id: latestVisit?.id || null,
                amount,
                currency,
                payment_type: paymentType,
                description,
                recorded_by: currentUser.id
            });

            alert(`Payment of ${amount} ${currency} recorded successfully for ${patient.name}!`);
            
            // Reset form
            document.getElementById('paymentForm').reset();
            document.getElementById('paymentPatientInfo').innerHTML = '';
            loadFinancialSummary();
            loadTransactions();
        }

        function recordExpense() {
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const currency = document.getElementById('expenseCurrency').value;
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDescription').value;

            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            const expense = db.add('expenses', {
                amount,
                currency,
                category,
                description,
                recorded_by: currentUser.id
            });

            alert(`Expense of ${amount} ${currency} recorded successfully!`);
            
            // Reset form
            document.getElementById('expenseForm').reset();
            loadFinancialSummary();
            loadTransactions();
        }

        function recordQuickPayment() {
            const name = document.getElementById('quickPatientName').value;
            const mobile = document.getElementById('quickPatientMobile').value;
            const amount = parseFloat(document.getElementById('quickPaymentAmount').value);
            const currency = document.getElementById('quickPaymentCurrency').value;
            const paymentType = document.getElementById('quickPaymentType').value;
            const description = document.getElementById('quickPaymentDescription').value;

            if (!name || !amount || amount <= 0) {
                alert('Please fill all required fields');
                return;
            }

            let patientId = null;
            if (mobile) {
                let patient = db.findPatientByMobile(mobile);
                if (!patient) {
                    // Register new patient quickly
                    patient = db.add('patients', {
                        name,
                        mobile,
                        age: 0,
                        sex: 'Unknown',
                        password: '1234',
                        registered_by: currentUser.id
                    });
                }
                patientId = patient.id;
            }

            const payment = db.add('payments', {
                patient_id: patientId,
                amount,
                currency,
                payment_type: paymentType,
                description: description || `Quick payment - ${name}`,
                recorded_by: currentUser.id
            });

            alert(`Quick payment of ${amount} ${currency} recorded for ${name}!`);
            
            // Reset form
            document.getElementById('quickPatientName').value = '';
            document.getElementById('quickPatientMobile').value = '';
            document.getElementById('quickPaymentAmount').value = '';
            document.getElementById('quickPaymentDescription').value = '';
            
            loadFinancialSummary();
            loadTransactions();
        }

        function loadPharmacyQueue() {
            const content = document.getElementById('mainContent');
            const queue = db.getQueueForDepartment('pharmacy');
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-users"></i> Pharmacy Queue
                                <span class="badge bg-danger ms-2">${queue.length} Waiting</span>
                            </div>
                            <div class="card-body">
                                ${queue.length === 0 ? 
                                    '<p class="text-muted">No prescriptions in queue.</p>' : 
                                    queue.map(item => {
                                        const patient = item.patient;
                                        const visit = item.visit;
                                        const prescription = db.getAll('prescriptions').find(p => p.visit_id == visit.id);
                                        
                                        return `
                                            <div class="patient-queue">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h5>${patient?.name || 'Unknown Patient'}</h5>
                                                        <p class="mb-1">
                                                            <i class="fas fa-phone"></i> ${patient?.mobile || 'N/A'} | 
                                                            <i class="fas fa-user"></i> ${patient?.sex || 'N/A'}, ${patient?.age || 'N/A'} yrs
                                                        </p>
                                                        <div class="mt-2">
                                                            <strong>Prescription:</strong>
                                                            <p class="mb-0 text-muted">${prescription?.drugs || 'No prescription found'}</p>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <button class="btn btn-success" onclick="dispensePrescription(${visit.id})">
                                                            <i class="fas fa-check-circle"></i> Dispense
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')
                                }
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-bar"></i> Pharmacy Statistics
                            </div>
                            <div class="card-body">
                                <div class="stat-card">
                                    <i class="fas fa-prescription-bottle fa-2x text-primary"></i>
                                    <div class="stat-number">${queue.length}</div>
                                    <div class="stat-label">Pending Prescriptions</div>
                                </div>
                                <div class="stat-card mt-3">
                                    <i class="fas fa-check-circle fa-2x text-success"></i>
                                    <div class="stat-number">${db.getAll('prescriptions').filter(p => p.status === 'dispensed').length}</div>
                                    <div class="stat-label">Dispensed Today</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function dispensePrescription(visitId) {
            const prescriptions = db.getAll('prescriptions');
            const prescription = prescriptions.find(p => p.visit_id == visitId);
            
            if (prescription) {
                db.update('prescriptions', prescription.id, { 
                    status: 'dispensed',
                    dispensed_by: currentUser.id,
                    dispensed_date: new Date().toISOString()
                });
                
                // Remove from queue
                const queueItems = db.getAll('queue').filter(q => 
                    q.visit_id == visitId && q.department === 'pharmacy'
                );
                queueItems.forEach(item => {
                    db.update('queue', item.id, { status: 'completed' });
                });
                
                alert('Prescription dispensed successfully!');
                loadPharmacyQueue();
            } else {
                alert('Prescription not found!');
            }
        }

        function loadPrescriptions() {
            const content = document.getElementById('mainContent');
            const prescriptions = db.getAll('prescriptions');
            const visits = db.getAll('visits');
            const patients = db.getAll('patients');
            
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-prescription"></i> All Prescriptions
                        <span class="badge bg-primary ms-2">${prescriptions.length} Total</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Patient</th>
                                        <th>Date</th>
                                        <th>Drugs</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${prescriptions.map(prescription => {
                                        const visit = visits.find(v => v.id == prescription.visit_id);
                                        const patient = patients.find(p => p.id == visit?.patient_id);
                                        
                                        return `
                                            <tr>
                                                <td>${patient?.name || 'Unknown'}</td>
                                                <td>${new Date(prescription.created_date).toLocaleDateString()}</td>
                                                <td>${prescription.drugs}</td>
                                                <td>
                                                    <span class="badge ${prescription.status === 'dispensed' ? 'bg-success' : 'bg-warning'}">
                                                        ${prescription.status || 'pending'}
                                                    </span>
                                                </td>
                                                <td>
                                                    ${prescription.status !== 'dispensed' ? `
                                                    <button class="btn btn-sm btn-success" onclick="dispensePrescription(${prescription.visit_id})">
                                                        <i class="fas fa-check-circle"></i> Dispense
                                                    </button>
                                                    ` : 'Completed'}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadLabQueue() {
            const content = document.getElementById('mainContent');
            const queue = db.getQueueForDepartment('lab');
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-users"></i> Laboratory Queue
                                <span class="badge bg-danger ms-2">${queue.length} Waiting</span>
                            </div>
                            <div class="card-body">
                                ${queue.length === 0 ? 
                                    '<p class="text-muted">No lab tests in queue.</p>' : 
                                    queue.map(item => {
                                        const patient = item.patient;
                                        const visit = item.visit;
                                        const labRequest = db.getAll('lab_requests').find(l => l.visit_id == visit.id);
                                        
                                        return `
                                            <div class="patient-queue">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h5>${patient?.name || 'Unknown Patient'}</h5>
                                                        <p class="mb-1">
                                                            <i class="fas fa-phone"></i> ${patient?.mobile || 'N/A'} | 
                                                            <i class="fas fa-user"></i> ${patient?.sex || 'N/A'}, ${patient?.age || 'N/A'} yrs
                                                        </p>
                                                        <div class="mt-2">
                                                            <strong>Tests Requested:</strong>
                                                            <p class="mb-0 text-muted">${labRequest?.tests || 'No tests specified'}</p>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <button class="btn btn-primary" onclick="recordLabResults(${visit.id})">
                                                            <i class="fas fa-flask"></i> Record Results
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')
                                }
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-bar"></i> Lab Statistics
                            </div>
                            <div class="card-body">
                                <div class="stat-card">
                                    <i class="fas fa-flask fa-2x text-primary"></i>
                                    <div class="stat-number">${queue.length}</div>
                                    <div class="stat-label">Pending Tests</div>
                                </div>
                                <div class="stat-card mt-3">
                                    <i class="fas fa-check-circle fa-2x text-success"></i>
                                    <div class="stat-number">${db.getAll('lab_requests').filter(l => l.status === 'completed').length}</div>
                                    <div class="stat-label">Completed Today</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function recordLabResults(visitId) {
            const labRequest = db.getAll('lab_requests').find(l => l.visit_id == visitId);
            const visit = db.getById('visits', visitId);
            const patient = db.getById('patients', visit?.patient_id);
            
            if (!labRequest) {
                alert('No lab request found for this visit');
                return;
            }
            
            const results = prompt(`Enter lab results for ${patient?.name || 'the patient'}:\n\nTests: ${labRequest.tests}\n\nEnter results:`);
            
            if (results !== null && results.trim()) {
                db.update('lab_requests', labRequest.id, { 
                    results: results.trim(),
                    status: 'completed',
                    completed_by: currentUser.id,
                    completed_date: new Date().toISOString()
                });
                
                // Remove from queue
                const queueItems = db.getAll('queue').filter(q => 
                    q.visit_id == visitId && q.department === 'lab'
                );
                queueItems.forEach(item => {
                    db.update('queue', item.id, { status: 'completed' });
                });
                
                alert('Lab results recorded successfully!');
                loadLabQueue();
            }
        }

        function loadLabTests() {
            const content = document.getElementById('mainContent');
            const labRequests = db.getAll('lab_requests');
            const visits = db.getAll('visits');
            const patients = db.getAll('patients');
            
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-flask"></i> All Lab Tests
                        <span class="badge bg-primary ms-2">${labRequests.length} Total</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Patient</th>
                                        <th>Date</th>
                                        <th>Tests</th>
                                        <th>Results</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${labRequests.map(request => {
                                        const visit = visits.find(v => v.id == request.visit_id);
                                        const patient = patients.find(p => p.id == visit?.patient_id);
                                        
                                        return `
                                            <tr>
                                                <td>${patient?.name || 'Unknown'}</td>
                                                <td>${new Date(request.created_date).toLocaleDateString()}</td>
                                                <td>${request.tests}</td>
                                                <td>${request.results || 'Pending'}</td>
                                                <td>
                                                    <span class="badge ${request.status === 'completed' ? 'bg-success' : 'bg-warning'}">
                                                        ${request.status || 'pending'}
                                                    </span>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadConsultations() {
            const content = document.getElementById('mainContent');
            const consultations = db.getAll('consultations');
            const visits = db.getAll('visits');
            const patients = db.getAll('patients');
            
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-clipboard"></i> All Consultations
                        <span class="badge bg-primary ms-2">${consultations.length} Total</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Patient</th>
                                        <th>Date</th>
                                        <th>Chief Complaint</th>
                                        <th>Diagnosis</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${consultations.map(consultation => {
                                        const visit = visits.find(v => v.id == consultation.visit_id);
                                        const patient = patients.find(p => p.id == visit?.patient_id);
                                        const queueItem = db.getAll('queue').find(q => q.visit_id == consultation.visit_id && q.department === 'doctor');
                                        const status = queueItem?.status === 'completed' ? 'Completed' : 
                                                     queueItem?.status === 'waiting_results' ? 'Awaiting Results' : 'In Progress';
                                        
                                        return `
                                            <tr>
                                                <td>${patient?.name || 'Unknown'}</td>
                                                <td>${new Date(consultation.created_date).toLocaleDateString()}</td>
                                                <td>${consultation.chief_complaint.substring(0, 50)}${consultation.chief_complaint.length > 50 ? '...' : ''}</td>
                                                <td>${consultation.diagnosis?.substring(0, 30) || 'Not specified'}${consultation.diagnosis && consultation.diagnosis.length > 30 ? '...' : ''}</td>
                                                <td>
                                                    <span class="badge ${status === 'Completed' ? 'bg-success' : status === 'Awaiting Results' ? 'bg-warning' : 'bg-info'}">
                                                        ${status}
                                                    </span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-info" onclick="viewConsultationDetails(${consultation.id})">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                    ${status !== 'Completed' ? `
                                                    <button class="btn btn-sm btn-warning" onclick="continueConsultation(${consultation.visit_id}, ${patient.id})">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    ` : ''}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function viewConsultationDetails(consultationId) {
            const consultation = db.getById('consultations', consultationId);
            const visit = db.getById('visits', consultation.visit_id);
            const patient = db.getById('patients', visit.patient_id);
            const labRequest = db.getAll('lab_requests').find(l => l.visit_id == visit.id);
            const prescription = db.getAll('prescriptions').find(p => p.visit_id == visit.id);
            
            let details = `Consultation Details:\n\nPatient: ${patient.name}\nDate: ${new Date(consultation.created_date).toLocaleDateString()}\nChief Complaint: ${consultation.chief_complaint}\nDiagnosis: ${consultation.diagnosis || 'N/A'}\nTreatment Plan: ${consultation.plan || 'N/A'}`;
            
            if (labRequest) {
                details += `\n\nLab Tests: ${labRequest.tests}`;
                if (labRequest.results) {
                    details += `\nLab Results: ${labRequest.results}`;
                }
            }
            
            if (prescription) {
                details += `\n\nPrescription: ${prescription.drugs}`;
            }
            
            alert(details);
        }

        function loadPatientHistory() {
            if (currentRole !== 'patient') {
                alert('This feature is only available for patients');
                return;
            }

            const content = document.getElementById('mainContent');
            const visits = db.getPatientVisits(currentUser.id);
            
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-history"></i> Visit History for ${currentUser.name}
                        <span class="badge bg-primary ms-2">${visits.length} Visits</span>
                    </div>
                    <div class="card-body">
                        ${visits.length === 0 ? 
                            '<p class="text-muted">No visit history found.</p>' : 
                            visits.map(visit => {
                                const consultation = db.getAll('consultations').find(c => c.visit_id == visit.id);
                                const labRequest = db.getAll('lab_requests').find(l => l.visit_id == visit.id);
                                const prescription = db.getAll('prescriptions').find(p => p.visit_id == visit.id);
                                
                                return `
                                    <div class="patient-queue">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h5>Visit on ${new Date(visit.created_date).toLocaleDateString()}</h5>
                                                <p><strong>Vitals:</strong> BP: ${visit.bp || 'N/A'}, PR: ${visit.pr || 'N/A'}, Temp: ${visit.temperature || 'N/A'}°C</p>
                                                ${consultation ? `<p><strong>Diagnosis:</strong> ${consultation.diagnosis || 'N/A'}</p>` : ''}
                                                ${labRequest ? `<p><strong>Lab Tests:</strong> ${labRequest.tests}</p>` : ''}
                                                ${prescription ? `<p><strong>Prescription:</strong> ${prescription.drugs}</p>` : ''}
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-primary" onclick="printSingleVisitReport(${visit.id})">
                                                    <i class="fas fa-print"></i> Print Report
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')
                        }
                    </div>
                </div>
            `;
        }

        function printSingleVisitReport(visitId) {
            const visit = db.getById('visits', visitId);
            const patient = currentUser;
            const consultation = db.getAll('consultations').find(c => c.visit_id == visitId);
            const labRequest = db.getAll('lab_requests').find(l => l.visit_id == visitId);
            const prescription = db.getAll('prescriptions').find(p => p.visit_id == visitId);

            const reportContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Medical Report - ${patient.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
                        .header h1 { color: #2c3e50; margin: 0; }
                        .section { margin-bottom: 30px; }
                        .section h2 { color: #3498db; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
                        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .footer { margin-top: 50px; text-align: center; font-size: 0.9em; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Beergeel Obstetrics and Gynecology Clinic</h1>
                        <p>Xero awr kasoo horjeedka Ayuub Restaurant inyar ka xiga dhanka Masjid Nuur</p>
                        <p>Contact: 0634026635 (Mobile/WhatsApp)</p>
                    </div>
                    
                    <div class="section">
                        <h2>Patient Information</h2>
                        <table>
                            <tr><th>Name:</th><td>${patient.name}</td></tr>
                            <tr><th>Age/Sex:</th><td>${patient.age} years / ${patient.sex}</td></tr>
                            <tr><th>Mobile:</th><td>${patient.mobile}</td></tr>
                            <tr><th>Visit Date:</th><td>${new Date(visit.created_date).toLocaleDateString()}</td></tr>
                        </table>
                    </div>
                    
                    <div class="section">
                        <h2>Vital Signs</h2>
                        <table>
                            <tr>
                                <th>Blood Pressure</th>
                                <th>Pulse Rate</th>
                                <th>Temperature</th>
                                <th>Weight</th>
                                <th>BMI</th>
                                <th>SPO₂</th>
                            </tr>
                            <tr>
                                <td>${visit.bp || 'N/A'}</td>
                                <td>${visit.pr || 'N/A'}</td>
                                <td>${visit.temperature || 'N/A'}°C</td>
                                <td>${visit.weight || 'N/A'} kg</td>
                                <td>${visit.bmi || 'N/A'}</td>
                                <td>${visit.spo || 'N/A'}%</td>
                            </tr>
                        </table>
                    </div>
                    
                    ${consultation ? `
                    <div class="section">
                        <h2>Consultation</h2>
                        <table>
                            <tr><th>Chief Complaint:</th><td>${consultation.chief_complaint}</td></tr>
                            <tr><th>History:</th><td>${consultation.history || 'N/A'}</td></tr>
                            <tr><th>Physical Examination:</th><td>${consultation.physical_exam || 'N/A'}</td></tr>
                            <tr><th>Diagnosis:</th><td>${consultation.diagnosis || 'N/A'}</td></tr>
                            <tr><th>Treatment Plan:</th><td>${consultation.plan || 'N/A'}</td></tr>
                        </table>
                    </div>
                    ` : ''}
                    
                    ${labRequest ? `
                    <div class="section">
                        <h2>Laboratory Tests</h2>
                        <p><strong>Requested Tests:</strong> ${labRequest.tests}</p>
                        ${labRequest.results ? `<p><strong>Results:</strong> ${labRequest.results}</p>` : ''}
                    </div>
                    ` : ''}
                    
                    ${prescription ? `
                    <div class="section">
                        <h2>Prescription</h2>
                        <p>${prescription.drugs}</p>
                    </div>
                    ` : ''}
                    
                    <div class="footer">
                        <p>This report was generated on ${new Date().toLocaleDateString()}</p>
                        <p>Beergeel Obstetrics and Gynecology Clinic - Your Health is Our Priority</p>
                    </div>
                </body>
                </html>
            `;

            // Create a new window and write the report
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportContent);
            printWindow.document.close();
            
            // Wait for content to load then print
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function printPatientReport() {
            if (currentRole !== 'patient') {
                alert('This feature is only available for patients');
                return;
            }

            const patient = currentUser;
            const visits = db.getPatientVisits(patient.id);
            
            if (visits.length === 0) {
                alert('No visit history found');
                return;
            }

            const latestVisit = visits[visits.length - 1];
            const consultation = db.getAll('consultations').find(c => c.visit_id == latestVisit.id);
            const labRequest = db.getAll('lab_requests').find(l => l.visit_id == latestVisit.id);
            const prescription = db.getAll('prescriptions').find(p => p.visit_id == latestVisit.id);

            const reportContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Medical Report - ${patient.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
                        .header h1 { color: #2c3e50; margin: 0; }
                        .section { margin-bottom: 30px; }
                        .section h2 { color: #3498db; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
                        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .footer { margin-top: 50px; text-align: center; font-size: 0.9em; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Beergeel Obstetrics and Gynecology Clinic</h1>
                        <p>Xero awr kasoo horjeedka Ayuub Restaurant inyar ka xiga dhanka Masjid Nuur</p>
                        <p>Contact: 0634026635 (Mobile/WhatsApp)</p>
                    </div>
                    
                    <div class="section">
                        <h2>Patient Information</h2>
                        <table>
                            <tr><th>Name:</th><td>${patient.name}</td></tr>
                            <tr><th>Age/Sex:</th><td>${patient.age} years / ${patient.sex}</td></tr>
                            <tr><th>Mobile:</th><td>${patient.mobile}</td></tr>
                            <tr><th>Visit Date:</th><td>${new Date(latestVisit.created_date).toLocaleDateString()}</td></tr>
                        </table>
                    </div>
                    
                    <div class="section">
                        <h2>Vital Signs</h2>
                        <table>
                            <tr>
                                <th>Blood Pressure</th>
                                <th>Pulse Rate</th>
                                <th>Temperature</th>
                                <th>Weight</th>
                                <th>BMI</th>
                                <th>SPO₂</th>
                            </tr>
                            <tr>
                                <td>${latestVisit.bp || 'N/A'}</td>
                                <td>${latestVisit.pr || 'N/A'}</td>
                                <td>${latestVisit.temperature || 'N/A'}°C</td>
                                <td>${latestVisit.weight || 'N/A'} kg</td>
                                <td>${latestVisit.bmi || 'N/A'}</td>
                                <td>${latestVisit.spo || 'N/A'}%</td>
                            </tr>
                        </table>
                    </div>
                    
                    ${consultation ? `
                    <div class="section">
                        <h2>Consultation</h2>
                        <table>
                            <tr><th>Chief Complaint:</th><td>${consultation.chief_complaint}</td></tr>
                            <tr><th>History:</th><td>${consultation.history || 'N/A'}</td></tr>
                            <tr><th>Physical Examination:</th><td>${consultation.physical_exam || 'N/A'}</td></tr>
                            <tr><th>Diagnosis:</th><td>${consultation.diagnosis || 'N/A'}</td></tr>
                            <tr><th>Treatment Plan:</th><td>${consultation.plan || 'N/A'}</td></tr>
                        </table>
                    </div>
                    ` : ''}
                    
                    ${labRequest ? `
                    <div class="section">
                        <h2>Laboratory Tests</h2>
                        <p><strong>Requested Tests:</strong> ${labRequest.tests}</p>
                        ${labRequest.results ? `<p><strong>Results:</strong> ${labRequest.results}</p>` : ''}
                    </div>
                    ` : ''}
                    
                    ${prescription ? `
                    <div class="section">
                        <h2>Prescription</h2>
                        <p>${prescription.drugs}</p>
                    </div>
                    ` : ''}
                    
                    <div class="footer">
                        <p>This report was generated on ${new Date().toLocaleDateString()}</p>
                        <p>Beergeel Obstetrics and Gynecology Clinic - Your Health is Our Priority</p>
                    </div>
                </body>
                </html>
            `;

            // Create a new window and write the report
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportContent);
            printWindow.document.close();
            
            // Wait for content to load then print
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function loadReports() {
            const content = document.getElementById('mainContent');
            const today = new Date().toDateString();
            
            const todayVisits = db.getTodayVisits().length;
            const totalPatients = db.getAll('patients').length;
            const todayPayments = db.getAll('payments').filter(p => 
                new Date(p.created_date).toDateString() === today
            ).reduce((sum, p) => sum + (p.amount || 0), 0);
            const todayExpenses = db.getAll('expenses').filter(e => 
                new Date(e.created_date).toDateString() === today
            ).reduce((sum, e) => sum + (e.amount || 0), 0);
            
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-bar"></i> Clinic Reports
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-calendar-day"></i> Today's Summary
                                    </div>
                                    <div class="card-body">
                                        <table class="table">
                                            <tr>
                                                <td>Visits Today</td>
                                                <td class="text-end"><strong>${todayVisits}</strong></td>
                                            </tr>
                                            <tr>
                                                <td>Total Income</td>
                                                <td class="text-end text-success"><strong>$${todayPayments.toFixed(2)}</strong></td>
                                            </tr>
                                            <tr>
                                                <td>Total Expenses</td>
                                                <td class="text-end text-danger"><strong>$${todayExpenses.toFixed(2)}</strong></td>
                                            </tr>
                                            <tr>
                                                <td>Net Income</td>
                                                <td class="text-end ${(todayPayments - todayExpenses) >= 0 ? 'text-success' : 'text-danger'}">
                                                    <strong>$${(todayPayments - todayExpenses).toFixed(2)}</strong>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-database"></i> Overall Statistics
                                    </div>
                                    <div class="card-body">
                                        <table class="table">
                                            <tr>
                                                <td>Total Patients</td>
                                                <td class="text-end"><strong>${totalPatients}</strong></td>
                                            </tr>
                                            <tr>
                                                <td>Total Visits</td>
                                                <td class="text-end"><strong>${db.getAll('visits').length}</strong></td>
                                            </tr>
                                            <tr>
                                                <td>Total Consultations</td>
                                                <td class="text-end"><strong>${db.getAll('consultations').length}</strong></td>
                                            </tr>
                                            <tr>
                                                <td>Total Prescriptions</td>
                                                <td class="text-end"><strong>${db.getAll('prescriptions').length}</strong></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h5>Export Reports</h5>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" onclick="exportTodayReport()">
                                    <i class="fas fa-file-excel"></i> Export Today's Report
                                </button>
                                <button class="btn btn-success" onclick="exportPatientList()">
                                    <i class="fas fa-file-csv"></i> Export Patient List
                                </button>
                                <button class="btn btn-warning" onclick="exportFinancialReport()">
                                    <i class="fas fa-file-invoice-dollar"></i> Export Financial Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function exportTodayReport() {
            alert('Report export functionality would be implemented here. In a real system, this would generate an Excel/PDF file.');
        }

        function exportPatientList() {
            alert('Patient list export functionality would be implemented here.');
        }

        function exportFinancialReport() {
            alert('Financial report export functionality would be implemented here.');
        }

        function registerPatient() {
            const name = document.getElementById('patientName').value;
            const age = document.getElementById('patientAge').value;
            const sex = document.getElementById('patientSex').value;
            const mobile = document.getElementById('patientMobile').value;
            const password = document.getElementById('patientPassword').value;

            if (!name || !age || !sex || !mobile) {
                alert('Please fill all required fields');
                return;
            }

            if (db.findPatientByMobile(mobile)) {
                alert('Patient with this mobile number already exists');
                return;
            }

            const patient = db.add('patients', {
                name,
                age: parseInt(age),
                sex,
                mobile,
                password,
                registered_by: currentUser.id
            });

            alert(`Patient registered successfully!\n\nPatient ID: ${mobile}\nPassword: ${password}\n\nPlease provide this information to the patient.`);
            loadDashboard();
        }

        function loadRegisterPatient() {
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-user-plus"></i> Register New Patient
                    </div>
                    <div class="card-body">
                        <form id="patientForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Full Name *</label>
                                        <input type="text" class="form-control" id="patientName" required>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Age *</label>
                                        <input type="number" class="form-control" id="patientAge" required min="0" max="150">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Sex *</label>
                                        <select class="form-select" id="patientSex" required>
                                            <option value="">Select</option>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Mobile Number *</label>
                                        <input type="tel" class="form-control" id="patientMobile" required 
                                               placeholder="7-10 digits">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Password (Default: 1234)</label>
                                        <input type="text" class="form-control" id="patientPassword" value="1234">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> 
                                Patient ID will be their mobile number. They can login with mobile and password.
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="registerPatient()">
                                <i class="fas fa-save"></i> Register Patient
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="loadDashboard()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function filterPatientList() {
            const searchTerm = document.getElementById('searchPatientList').value;
            const patients = db.searchPatients(searchTerm);
            const tableBody = document.getElementById('patientListTable');
            
            tableBody.innerHTML = patients.map(patient => {
                const visits = db.getPatientVisits(patient.id);
                const latestVisit = visits[visits.length - 1];
                
                return `
                    <tr>
                        <td>${patient.id}</td>
                        <td>${patient.name}</td>
                        <td>${patient.mobile}</td>
                        <td>${patient.age} yrs / ${patient.sex}</td>
                        <td>${new Date(patient.created_date).toLocaleDateString()}</td>
                        <td><span class="badge bg-info">${visits.length}</span></td>
                        <td>
                            <div class="btn-group">
                                ${currentRole === 'reception' ? `
                                <button class="btn btn-sm btn-primary" onclick="createVisitForPatient(${patient.id})">
                                    <i class="fas fa-stethoscope"></i> Visit
                                </button>
                                <button class="btn btn-sm btn-success" onclick="recordPaymentForPatient(${patient.id})">
                                    <i class="fas fa-money-bill"></i> Payment
                                </button>
                                ` : ''}
                                ${currentRole === 'doctor' && latestVisit ? `
                                <button class="btn btn-sm btn-warning" onclick="editConsultationFromPatientList(${latestVisit.id}, ${patient.id})">
                                    <i class="fas fa-edit"></i> Edit Consultation
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Beergeel Obstetrics and Gynecology Clinic System initialized');
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>